#
# Configuration file for KISS bootstrapper
#

# Root directory
# This is where the rootfs will be installed.
MNTDIR="/tmp/rootfs"

# List of packages to be installed
# Most of those are already dependencies
# of each other but it is not a bad idea
# to put them to the list anyway.
PKGS="baselayout kiss musl gcc make pigz xz zlib bzip2 binutils bison curl \
     linux-headers m4 flex busybox perl pkgconf openssl git"

# Build flags
# It is a good idea to not use flags like "native"
# If you plan on using the tarball on another computer
# due to architechtural differences. You can manually
# override this march configuration here by removing the
# case.
#
march=$(uname -m)
case "$march" in
    x86_64) march=x86-64 ;;
    i*86)   march=i686   ;;
esac
CFLAGS="-march=$march -mtune=generic -pipe -Os"
CXXFLAGS="-march=$march -mtune=generic -pipe -Os"
MAKEFLAGS="-j$(nproc)"

# Repository
# This repository will be cloned to /tmp/repo on the
# host, and /var/db/kiss/repo on the target system.
REPO="git+https://github.com/kisslinux/repo"
HOST_REPO_PATH="/tmp/repo/core:/tmp/repo/extra"

# Hooks
# By default, keep empty to prevent breakage.
KISS_HOOK=""

export MNTDIR PKGS CFLAGS CXXFLAGS REPO HOST_REPO_PATH MAKEFLAGS KISS_HOOK

postrepodown() {
	# This function runs after the repository has been downloaded, and allows
	# for a 'quick fix' for certain packages. As a default case this fixes
	# openssl, since openssl's 'update-certdata.sh' does not respect KISS_ROOT.
	cat <<EOF > core/openssl/post-install
#/bin/sh
echo "run '/etc/ssl/update-certdata.sh' as root"
EOF
	true
}

postinstall() {
	# You can preferably add some custom
	# commands if you want a postinstall
	# procedure. This runs right after kiss
	# install is complete

	# Currently default function is 'true'
	# because there is nothing else to be done,
	# but you can safely remove it if you will
	# be adding some post-installation commands

	# Since we override openssl's post-install hook, we effectively run it here.
	curl -sL https://curl.haxx.se/ca/cacert.pem > "${MNTDIR:?ERROR: MNTDIR not set}/etc/ssl/cert.pem"

	true
}

# vim:filetype=sh
